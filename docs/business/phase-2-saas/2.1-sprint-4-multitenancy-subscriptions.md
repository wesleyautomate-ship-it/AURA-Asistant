# Phase 2, Sprint 4: Multi-Tenancy & Subscriptions

## ðŸŽ¯ Objective
Refactor the application to support multiple tenants (organizations) and integrate a payment provider to manage B2B subscriptions. This is the foundational step for commercializing the AI recipes.

## Associated Files

### Backend
- All database models (`user.py`, `property.py`, etc.) - Add `organization_id`.
- All services and repositories - Update queries to be organization-scoped.
- `/backend/app/models/organization.py`
- `/backend/app/schemas/organization.py`
- `/backend/app/services/subscription_service.py`
- `/backend/app/api/v1/endpoints/subscriptions.py`
- `/.env` (Add `STRIPE_API_KEY`)

### Frontend
- `/frontend/src/screens/BillingScreen.tsx`
- `/frontend/src/services/subscriptionService.ts`
- `/frontend/src/store/userStore.ts` (Update to include organization info)

## Implementation Details

### 1. Backend Development

-   **Multi-Tenancy Refactor**:
    -   Create an `Organization` model in the database.
    -   Add a mandatory `organization_id` foreign key to all relevant models (`User`, `Property`, `Client`, `Request`, `Task`).
    -   **Crucially, update every single database query in every repository and service to filter by the current user's `organization_id`.** Data must be strictly isolated between tenants.
    -   When a new user registers, create a new `Organization` for them and assign them as its first user.

-   **Stripe Integration & Plan Management**:
    -   Add the `stripe` Python library to `requirements.txt`.
    -   Add your `STRIPE_API_KEY` to the `.env` file.
    -   Create a `subscription_service.py` to handle creating Stripe Customers and managing subscription lifecycles.
    -   Define subscription plans (e.g., 'Basic', 'Pro', 'Enterprise') that gate access to certain features. For example:
        -   **Basic Tier**: Limited number of Marketing/CMA recipe runs per month.
        -   **Pro Tier**: Unlimited recipes, access to team features.

-   **Subscription API Endpoints**:
    -   Create `endpoints/subscriptions.py`.
    -   `POST /subscriptions/create-checkout-session`: Takes a price ID and returns a URL for a Stripe Checkout session.
    -   `POST /subscriptions/webhook`: An unprotected endpoint to receive and process webhooks from Stripe, updating an organization's subscription status (`active`, `canceled`).
    -   `GET /subscriptions/`: Get the current organization's subscription status and usage.

### 2. Frontend Development

-   **State Management**: Update the `userStore` to hold the user's organization and subscription plan details.
-   **Billing UI (`BillingScreen.tsx`)**: Develop a screen for admins to view their current plan, see usage (e.g., "7 of 10 CMA reports used this month"), and upgrade or manage their subscription.
-   **Feature Gating**: In the UI, disable or hide features that are not included in the user's current subscription plan. For example, if a user on the 'Basic' tier has used all their CMA reports, the option to generate a new one in the `CommandCenter` should be disabled.

## âœ… Acceptance Criteria
-   **Backend**:
    -   [ ] Data is strictly isolated between different organizations.
    -   [ ] The system can create and manage subscriptions via Stripe.
    -   [ ] API endpoints correctly report subscription status and gate access to features based on the active plan.
-   **Frontend**:
    -   [ ] The `BillingScreen` correctly displays the current plan and usage.
    -   [ ] Users can successfully upgrade or manage their subscription.
    -   [ ] The UI correctly disables features for users who have exceeded their plan's limits or do not have access.