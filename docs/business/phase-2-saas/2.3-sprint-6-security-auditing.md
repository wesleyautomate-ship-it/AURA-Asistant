# Phase 2, Sprint 6: Advanced Security & Auditing

## ðŸŽ¯ Objective
Enhance the application's security and compliance by implementing comprehensive audit trails for all tenant actions and hardening the production infrastructure.

## Associated Files

### Backend
- `/backend/app/models/audit_log.py`
- `/backend/app/services/audit_service.py`
- All services (`property_service.py`, `request_service.py`, etc.) - Add audit logging calls.
- `/backend/app/main.py` (Add security middleware)

### Infrastructure
- `/.github/workflows/ci.yml` (Add security scanning stage)
- `/backend/Dockerfile` (Harden the image)

## Implementation Details

### 1. Backend Development

-   **Audit Log Model**:
    -   Create an `AuditLog` SQLAlchemy model.
    -   Fields must include `id`, `organization_id`, `user_id`, `action` (e.g., 'CREATE_REQUEST'), `target_id` (e.g., the ID of the request), `details` (a JSONB field for storing relevant data like the user's prompt), and a `timestamp`.

-   **Audit Service**:
    -   Create a lightweight `audit_service.py` with a method `log_action(user, action, target_id, details)`.
    -   Integrate this `log_action` call into all key business logic flows. For example, after a user submits a new request in the `CommandCenter`, a log entry should be created. This is crucial for security, billing, and future analytics.

-   **Security Hardening**:
    -   In `main.py`, add middleware for security headers (e.g., `X-Content-Type-Options`, `Strict-Transport-Security`, `Content-Security-Policy`).
    -   Implement API rate limiting using a library like `slowapi`. Apply stricter limits to expensive, unauthenticated, or sensitive endpoints.

### 2. Infrastructure & CI/CD

-   **Security Scanning**:
    -   Update the `ci.yml` workflow to include a security scanning step for the container images using a tool like **Trivy**.
    -   Configure this step to fail the CI/CD pipeline if any 'CRITICAL' or 'HIGH' severity vulnerabilities are detected in the final image.

-   **Docker Image Hardening**:
    -   Review the `backend/Dockerfile` to ensure it uses a multi-stage build, copying only the necessary application code and dependencies into the final image.
    -   Confirm the final stage runs the application as a non-root user.

-   **Production Monitoring & Alerting**:
    -   Set up alerts in your monitoring system (e.g., Grafana) for security-related events, such as:
        -   A spike in 4xx error codes (e.g., 401 Unauthorized, 403 Forbidden).
        -   Anomalous activity detected in the audit log.
        -   High resource usage that could indicate a denial-of-service attack.

## âœ… Acceptance Criteria
-   **Backend**:
    -   [ ] An `AuditLog` entry is created for every significant action, including request submissions, content generation, and user management changes.
    -   [ ] API responses include appropriate security headers.
    -   [ ] The API correctly enforces rate limits.
-   **Infrastructure**:
    -   [ ] The CI/CD pipeline blocks deployments if high-severity vulnerabilities are found.
    -   [ ] The production Docker container runs as a non-root user and is minimized.
-   **Auditing**:
    -   [ ] It is possible to query the `audit_log` table to get a clear history of all actions performed within a specific organization's account.